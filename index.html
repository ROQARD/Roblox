<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoStats | Proxy Fixed</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        :root {
            --bg: #050505;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #00ff88;
            --text: #ffffff;
            --text-dim: #888;
            --error: #ff4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 550px; }

        .search-box {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 { font-weight: 800; font-size: 2.2rem; margin-bottom: 15px; letter-spacing: -1px; }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        input {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
            transition: 0.2s;
        }
        input:focus { border-color: var(--accent); }

        button {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0 25px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }

        #status {
            margin-top: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            min-height: 20px;
        }

        /* Results */
        .result-card {
            display: none;
            flex-direction: column;
            gap: 12px;
            animation: fadeIn 0.4s ease-out;
        }

        .stat-row {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 18px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 10px;
            background: linear-gradient(90deg, rgba(0,255,136,0.1), transparent);
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 5px;
        }
        .header img { width: 64px; height: 64px; border-radius: 12px; }

        .label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; font-weight: 700; }
        .value { font-size: 1.5rem; font-weight: 800; }
        .live { color: var(--accent); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="search-box">
        <h1>Ro<span style="color:var(--accent)">Stats</span></h1>
        <div style="color:var(--text-dim); font-size:0.9rem;">Powered by RoProxy + CORS Bridge</div>
        
        <div class="input-group">
            <input type="text" id="placeId" placeholder="Enter Place ID (e.g. 920587237)">
            <button onclick="init()">Connect</button>
        </div>
        <div id="status"></div>
    </div>

    <div id="results" class="result-card">
        <div class="header">
            <img id="gIcon" src="">
            <div style="text-align:left;">
                <div id="gName" style="font-weight:700; font-size:1.1rem;">Game Name</div>
                <div id="gCreator" style="color:var(--accent); font-size:0.85rem;">Creator</div>
            </div>
        </div>

        <div class="stat-row">
            <div>
                <div class="label">Playing Now</div>
                <div class="value live" id="gPlaying">0</div>
            </div>
            <div style="text-align:right;">
                <div class="label">Visits</div>
                <div class="value" id="gVisits" style="font-size:1.1rem;">0</div>
            </div>
        </div>

        <div class="stat-row">
            <div>
                <div class="label">Last Update</div>
                <div class="value" id="gUpdate" style="font-size:1rem;">-</div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. We use 'codetabs' to bypass the browser CORS block.
    // 2. We request 'roproxy.com' inside that bridge.
    const BRIDGE = "https://api.codetabs.com/v1/proxy?quest=";
    const DOMAIN = "roproxy.com"; 

    function smartFormat(n) {
        if (!n || isNaN(n)) return "0";
        if (n >= 1e9) return (n / 1e9).toFixed(2) + "B";
        if (n >= 1e6) return (n / 1e6).toFixed(1) + "M";
        if (n >= 1e3) return (n / 1e3).toFixed(1) + "K";
        return n.toLocaleString();
    }

    async function fetchBridge(url) {
        // Encode URL to prevent breaking the bridge query
        const target = BRIDGE + encodeURIComponent(url);
        const res = await fetch(target);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    }

    async function init() {
        const input = document.getElementById('placeId').value.trim();
        const id = input.match(/\d+/)?.[0];
        const status = document.getElementById('status');
        const results = document.getElementById('results');

        if (!id) {
            status.innerText = "Please enter a valid numeric ID.";
            status.style.color = "var(--error)";
            return;
        }

        status.innerText = "Connecting to RoProxy Bridge...";
        status.style.color = "var(--text-dim)";
        results.style.display = 'none';

        try {
            let universeId = null;

            // STEP 1: Try to convert Place ID -> Universe ID
            // We use apis.roproxy.com via the bridge
            try {
                const uniData = await fetchBridge(`https://apis.${DOMAIN}/universes/v1/places/${id}/universe`);
                universeId = uniData.universeId;
            } catch (e) {
                console.log("Conversion failed, assuming ID is already Universe ID...");
                universeId = id; // Fallback: User might have entered Universe ID directly
            }

            if (!universeId) throw new Error("Could not find Game Universe.");

            // STEP 2: Get Game Details using Universe ID
            // We use games.roproxy.com via the bridge
            const [gameData, iconData] = await Promise.all([
                fetchBridge(`https://games.${DOMAIN}/v1/games?universeIds=${universeId}`),
                fetchBridge(`https://thumbnails.${DOMAIN}/universes/v1/icons?universeIds=${universeId}&size=150x150&format=Png&isCircular=false`)
            ]);

            const d = gameData.data[0];
            
            if (!d) throw new Error("No data found for this ID.");

            // Render
            document.getElementById('gName').innerText = d.name;
            document.getElementById('gCreator').innerText = "By " + d.creator.name;
            document.getElementById('gPlaying').innerText = smartFormat(d.playing);
            document.getElementById('gVisits').innerText = smartFormat(d.visits);
            document.getElementById('gUpdate').innerText = new Date(d.updated).toLocaleDateString();
            
            const iconUrl = iconData.data?.[0]?.imageUrl || "";
            document.getElementById('gIcon').src = iconUrl;

            status.innerText = "Connected via RoProxy.";
            status.style.color = "var(--accent)";
            results.style.display = 'flex';

        } catch (err) {
            console.error(err);
            status.innerText = "Connection Failed. Verify ID or check network.";
            status.style.color = "var(--error)";
        }
    }
</script>

</body>
</html>
