<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoStats Ultimate Engine</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        :root {
            --bg: #030303;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #00ffa2;
            --text: #ffffff;
            --text-dim: #999;
            --higher: #00ff88;
            --lower: #ff4d4d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 1100px; }

        /* Search Section */
        .search-section {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: 28px;
            margin-bottom: 25px;
            text-align: center;
        }

        h1 { font-weight: 800; font-size: 2.8rem; letter-spacing: -2px; margin-bottom: 15px; }
        .accent-text { color: var(--accent); }
        
        .compare-box {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 18px;
            border: 1px solid var(--border);
            margin: 20px 0;
        }

        input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            padding: 12px;
            font-size: 1rem;
            outline: none;
            border-bottom: 2px solid var(--border);
        }
        input:focus { border-bottom: 2px solid var(--accent); }

        button {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 15px 45px;
            border-radius: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
        }

        button:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 5px 15px rgba(0, 255, 162, 0.3); }

        /* History */
        .history-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 15px; }
        .history-chip {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-dim);
        }
        .history-chip:hover { background: var(--accent); color: #000; }

        /* Dashboard Grid */
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; display: none; }
        .side { display: flex; flex-direction: column; gap: 15px; }

        .card {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 22px;
            border-radius: 24px;
            transition: 0.3s;
        }
        
        .header-card {
            grid-column: span 2;
            display: flex;
            align-items: center;
            gap: 20px;
            background: linear-gradient(135deg, rgba(0,255,162,0.07) 0%, rgba(255,255,255,0.02) 100%);
        }

        .header-card img { width: 90px; height: 90px; border-radius: 20px; }
        .label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 8px; }
        .value { font-size: 1.4rem; font-weight: 800; }
        
        .diff-higher { color: var(--higher); }
        .diff-lower { color: var(--lower); }

        .desc-box { grid-column: span 2; max-height: 80px; overflow-y: auto; color: #bbb; line-height: 1.5; font-size: 0.85rem; padding-right: 10px; }
        .desc-box::-webkit-scrollbar { width: 4px; }
        .desc-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        #status { font-size: 0.85rem; color: var(--accent); text-align: center; font-weight: 600; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="search-section">
            <h1>Ro<span class="accent-text">Stats</span></h1>
            <div class="compare-box">
                <input type="text" id="id1" placeholder="Place ID 1 (Required)">
                <span style="color:var(--text-dim); font-weight:800;">VS</span>
                <input type="text" id="id2" placeholder="Place ID 2 (Optional)">
            </div>
            <button onclick="compare()">Analyze</button>
            <div id="status"></div>
            <div class="history-container" id="history"></div>
        </div>

        <div class="comparison-grid" id="compGrid">
            <div class="side" id="sideA"></div>
            <div class="side" id="sideB"></div>
        </div>
    </div>

<script>
    // Proxied endpoints for maximum data access
    const _B64 = {
        u: "aHR0cHM6Ly9hcGlzLnJvYmxveC5jb20vdW5pdmVyc2VzL3YxL3BsYWNlcy8=", // Get UniverseId
        g: "aHR0cHM6Ly9nYW1lcy5yb2Jsb3guY29tL3YxL2dhbWVzP3VuaXZlcnNlSWRzPQ==", // General Stats
        v: "aHR0cHM6Ly9nYW1lcy5yb2Jsb3guY29tL3YxL2dhbWVzL3ZvdGVzP3VuaXZlcnNlSWRzPQ==", // Likes/Dislikes
        i: "aHR0cHM6Ly90aHVtYm5haWxzLnJvYmxveC5jb20vdW5pdmVyc2VzL3YxL2ljb25zP3VuaXZlcnNlSWRzPQ==", // Icon
        b: "aHR0cHM6Ly9iYWRnZXMucm9ibG94LmNvbS92MS91bml2ZXJzZXMv", // Badges
        p: "aHR0cHM6Ly9nYW1lcy5yb2Jsb3guY29tL3YxL2dhbWVzLw==", // Gamepasses/VIP
    };

    const PROXY = "https://api.codetabs.com/v1/proxy?quest=";

    document.addEventListener('DOMContentLoaded', updateHistoryUI);

    function smartFormat(n) {
        if (!n || isNaN(n)) return "0";
        if (n >= 1e9) return (n / 1e9).toFixed(2) + "B";
        if (n >= 1e6) return (n / 1e6).toFixed(1) + "M";
        if (n >= 1e3) return (n / 1e3).toFixed(1) + "K";
        return n.toLocaleString();
    }

    async function stealthFetch(key, suffix = "") {
        const url = atob(_B64[key]) + suffix;
        const res = await fetch(PROXY + encodeURIComponent(url));
        if (!res.ok) throw "Bridge Error";
        return res.json();
    }

    async function getGameData(pid) {
        // 1. Get Universe ID
        const univ = await stealthFetch('u', pid + "/universe");
        const uid = univ.universeId;

        // 2. Fetch all data in parallel
        const [game, vote, icon, badges, passes] = await Promise.all([
            stealthFetch('g', uid),
            stealthFetch('v', uid),
            stealthFetch('i', uid + "&size=150x150&format=Png&isCircular=false"),
            stealthFetch('b', uid + "/badges?limit=1"), // Just need count
            stealthFetch('p', uid + "/game-passes?limit=1") // Just need count
        ]);

        const d = game.data[0];
        const v = vote.data[0];
        const ratio = (v.upVotes + v.downVotes === 0) ? 0 : Math.round((v.upVotes / (v.upVotes + v.downVotes)) * 100);

        return {
            id: pid,
            name: d.name,
            creator: d.creator.name,
            icon: icon.data[0]?.imageUrl,
            desc: d.description,
            genre: d.genre,
            // Main Stats
            active: d.playing,
            visits: d.visits,
            favs: d.favoritedCount,
            rating: ratio,
            // Deep Stats
            badges: badges.totalResults || 0,
            passes: passes.totalResults || 0,
            maxPlayers: d.maxPlayers,
            // Raw data for comparison logic
            raw: { active: d.playing, visits: d.visits, favs: d.favoritedCount, rating: ratio }
        };
    }

    function createCard(data, type) {
        let activeClass = "", visitsClass = "", favsClass = "";

        if (type === 'compare') {
            const other = data.otherRaw;
            activeClass = data.raw.active > other.active ? "diff-higher" : (data.raw.active < other.active ? "diff-lower" : "");
            visitsClass = data.raw.visits > other.visits ? "diff-higher" : (data.raw.visits < other.visits ? "diff-lower" : "");
            favsClass = data.raw.favs > other.favs ? "diff-higher" : (data.raw.favs < other.favs ? "diff-lower" : "");
        }

        return `
            <div class="card header-card">
                <img src="${data.icon}">
                <div>
                    <h2>${data.name}</h2>
                    <div class="accent" style="font-weight:600;">By ${data.creator}</div>
                </div>
            </div>
            <div class="card desc-box">${data.desc}</div>
            
            <div class="card"><div class="label">Live Players</div><div class="value ${activeClass}">${smartFormat(data.active)}</div></div>
            <div class="card"><div class="label">Total Visits</div><div class="value ${visitsClass}">${smartFormat(data.visits)}</div></div>
            <div class="card"><div class="label">Favorites</div><div class="value ${favsClass}">${smartFormat(data.favs)}</div></div>
            <div class="card"><div class="label">Rating</div><div class="value">${data.rating}%</div></div>
            
            <div class="card"><div class="label">Badges</div><div class="value">${smartFormat(data.badges)}</div></div>
            <div class="card"><div class="label">Game Passes</div><div class="value">${smartFormat(data.passes)}</div></div>
            <div class="card"><div class="label">Genre</div><div class="value" style="font-size:1.1rem;">${data.genre}</div></div>
            <div class="card"><div class="label">Max Players</div><div class="value">${data.maxPlayers}</div></div>
        `;
    }

    async function compare() {
        const id1 = document.getElementById('id1').value.trim().match(/\d+/)?.[0];
        const id2 = document.getElementById('id2').value.trim().match(/\d+/)?.[0];
        const status = document.getElementById('status');
        const grid = document.getElementById('compGrid');

        if (!id1) return;
        status.innerText = "Querying RoProxy engines...";
        grid.style.display = "none";

        try {
            const data1 = await getGameData(id1);
            saveToHistory(id1, data1.name);

            if (id2) {
                const data2 = await getGameData(id2);
                saveToHistory(id2, data2.name);
                
                data1.otherRaw = data2.raw;
                data2.otherRaw = data1.raw;

                document.getElementById('sideA').innerHTML = createCard(data1, 'compare');
                document.getElementById('sideB').innerHTML = createCard(data2, 'compare');
            } else {
                document.getElementById('sideA').innerHTML = createCard(data1, 'single');
                document.getElementById('sideB').innerHTML = "";
            }
            
            status.innerText = "";
            grid.style.display = "grid";

        } catch (err) {
            status.innerText = "Error: API rate limit exceeded or invalid ID.";
            status.style.color = "#ff4d4d";
        }
    }

    /* History System */
    function saveToHistory(id, name) {
        let history = JSON.parse(localStorage.getItem('rbx_history') || '[]');
        history = history.filter(item => item.id !== id);
        history.unshift({ id, name });
        if (history.length > 8) history.pop();
        localStorage.setItem('rbx_history', JSON.stringify(history));
        updateHistoryUI();
    }

    function updateHistoryUI() {
        const container = document.getElementById('history');
        const history = JSON.parse(localStorage.getItem('rbx_history') || '[]');
        container.innerHTML = "";
        history.forEach(item => {
            const chip = document.createElement('div');
            chip.className = 'history-chip';
            chip.innerText = item.name.length > 15 ? item.name.substring(0, 15) + "..." : item.name;
            chip.title = item.name;
            chip.onclick = () => {
                document.getElementById('id1').value = item.id;
                compare();
            };
            container.appendChild(chip);
        });
    }
</script>
</body>
</html>
